<!DOCTYPE html>
<html>
<head>
<link href='https://fonts.googleapis.com/css?family=Maven Pro' rel='stylesheet'>
<link href='styles.css' rel='stylesheet'>
<title>RPC Console</title>
</head>
<body onload="start()">
<script type="text/javascript" src="rpc.js"></script>
<div class="output" id="output"></div>
<div class="panel">
<div class="label"> Command: </div>
<div class="input" id="input" contenteditable="true"></div>
</div>

<script type="text/javascript">
"use strict";
function start() {
	var rpc = new RpcClient("");
	var input = window.input;
	input.addEventListener("keydown", function(ev) {
		var x = ev.which || ev.keyCode;
		if (x == 13) {
			ev.preventDefault();
			sendCommand(rpc, input.innerText).then(function(){			
				input.focus();
			});
			input.innerText="";
		} else if (x == 9) {
			ev.preventDefault();
			showHelp(rpc, input.innerText);
		}
	});
	input.focus();
}

function scroll() {
    window.scrollTo(0,document.body.scrollHeight);	
    window.input.focus();
}


function clearElement(elem) {
	while (elem.firstChild) elem.removeChild(elem.firstChild);
}

function addControls(rpc, root, cmd) {
	root.classList.add("row");
    var res = document.createElement("div");
    res.classList.add("outdata");
    res.classList.add("pending");
	var reloadButton = document.createElement("button");
	reloadButton.classList.add("reload");
    reloadButton.addEventListener("click", function() {    	
    	res.classList.remove("result");
    	res.classList.remove("error");
    	res.classList.add("pending");
    	rpc.call2(cmd.method, cmd.args)
    	   .then(function(x) {clearElement(res); return x;},
    			   function(x) {clearElement(res); throw x;})
    	   .then(outputResult.bind(null, res),outputError.bind(null,res));
    });
    var closeButton = document.createElement("button");    
    closeButton.classList.add("close");
    closeButton.addEventListener("click", function() {
    	root.classList.add("disappear");
    	setTimeout(function() {
    		root.parentElement.removeChild(root);
    	},500);
    });
    var ln = outputCommand(root,cmd.method, cmd.args);
    ln.appendChild(reloadButton);
    ln.appendChild(closeButton);
    root.appendChild(res);
    return res;
}

function sendCommand(rpc, cmd) {
	var parsed = parseCmd(cmd);
	if (parsed) {
		var root = document.createElement("div");
		var d = addControls(rpc,root, parsed);
	    window.output.appendChild(root);
		scroll();
		return rpc.call2(parsed.method, parsed.args)
			.then(outputResult.bind(null,d), outputError.bind(null,d))			
			.then(scroll);
			
	} else {
		throw "Invalid command";
	}
}
	

function outputCommand(elem, method, args) {
	var d = document.createElement("div");
	d.classList.add("outdata");
	d.classList.add("command");
	var c = document.createElement("span")
	c.classList.add("command");
	c.appendChild(document.createTextNode(method));
	d.appendChild(c);
	var p = document.createElement("span");
	p.classList.add("command");
	var strargs = JSON.stringify(args);
	p.appendChild(document.createTextNode(strargs));
	d.appendChild(p);
    elem.appendChild(d);   

    d.addEventListener("click", function(){
    	window.input.innerText =  method+" "+strargs;
    });
    return d;
}

function outputResult(d,result) {
	d.classList.replace("pending","result");
	var json = formatJson(result);
	d.appendChild(json);
}

function outputError(d,result) {
	d.classList.replace("pending","error");
	var json = formatJson(result);
	d.appendChild(json);
}

function formatJson(json) {	
	var d = document.createElement("x-itm");

	if (json === null) {
		d.classList.add("null");
		d.appendChild(document.createTextNode("null"));		
	} else if (typeof json == "object") {
		if (Array.isArray(json)) {
			d.classList.add("array");
			var len = json.length;
			d.appendChild(document.createTextNode("["));
			for (var i = 0; i < len; i++) {
				if (i) d.appendChild(document.createTextNode(", "));
				d.appendChild(formatJson(json[i]));
			}
			d.appendChild(document.createTextNode("]"));
			
		} else {
			d.classList.add(typeof json);
			d.appendChild(document.createTextNode("{"));
			var prevEl = null;
			for (var x in json) {
				var dr = document.createElement("x-itm");
				if (prevEl)prevEl.appendChild(document.createTextNode(", "));
				var name = "\"" + x + "\"";
				dr.classList.add("keyvalue");
				var dk = document.createElement("x-itm");
				dk.classList.add("key");
				dk.appendChild(document.createTextNode(name));
				var dv = document.createElement("x-itm");
				dv.classList.add("value");
				dv.appendChild(formatJson(json[x]));
				dr.appendChild(dk);
				dr.appendChild(document.createTextNode(":"));
				dr.appendChild(dv);
				d.appendChild(dr);
				prevEl = dv;
			}
			d.appendChild(document.createTextNode("}"));
		}
	} else {
		d.classList.add(typeof json);
		var x = json.toString();
		if (typeof json == "string") x = "\""  + x +"\"";
		d.appendChild(document.createTextNode(x));
	} 
	return d;
}
	
function parseCmd(cmd) {
	var i1 = /^ *([-a-zA-Z0-9_.]+)[^\[{]*([\s\S]*)$/;
	var m = i1.exec(cmd);
	if (m[2].length) {
		return {
			method: m[1],
			args: eval("("+m[2]+")")
		};
	} else {
		return null;
	}
}

</script>
</body>
</html>